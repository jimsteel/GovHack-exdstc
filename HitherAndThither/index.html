<html>
<title>Hither and Thither</title>

<script src="d3/d3.v3.min.js"></script>
<script src="d3/topojson.v1.min.js"></script>
<script src="js/datamaps.world.min.js"></script>
<h1>Hither and Thither: <span id="date">None</span></h1>
  <input type="radio" name="direction" id="arrivalDir" value="Arrivals" checked>Arrivals
  <input type="radio" name="direction" id="departureDir" value="Departures">Departures
<div id="container" style="position: relative; width: 95%; height: 80%;">
</div>
<script>

var ausLat = [-25.27439, 133.775136],
  map = new Datamap({
  element: document.getElementById('container'),
  projection: 'mercator',
  setProjection: function(element, options) {
            var projection, path;
            projection = d3.geo.mercator()
                //.center([125, 0])
                //.scale(element.offsetWidth)
                .rotate([-160,5])
                //.translate([element.offsetWidth / 2, element.offsetHeight / 2])
;

            path = d3.geo.path()
                .pointRadius(2)
                .projection( projection );

            return {path: path, projection: projection};
        },
  fills: { defaultFill: '#ABDDA4', "bubble": "#1ff", "x": "#f1f" },
  geographyConfig: {
        dataUrl: null, //if not null, datamaps will fetch the map JSON (currently only supports topojson)
        hideAntarctica: false,
        borderWidth: 1,
        borderColor: '#FDFDFD',
        popupTemplate: function(geography, data) { //this function should just return a string
          return '<div class="hoverinfo"><strong>' + geography.properties.name + '</strong></div>';
        },
        popupOnHover: true, //disable the popup while hovering
        highlightOnHover: true,
        highlightFillColor: '#FC8D59',
        highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
        highlightBorderWidth: 2
    },
  bubbleConfig: {
        borderWidth: 2,
        borderColor: '#FFFFFF',
        popupOnHover: false,
        popupTemplate: function(geography, data) {
          return '<div class="hoverinfo"><strong>' + data.name + '</strong></div>';
        },
        fillOpacity: 0.75,
        highlightOnHover: true,
        highlightFillColor: '#FC8D59',
        highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
        highlightBorderWidth: 2,
        highlightFillOpacity: 0.85
    }
});


d3.csv('data/countries.csv', function(error, csvData) {
  d3.csv('data/340105.csv', function(error, arrivalsMonths) {
    d3.csv('data/340109.csv', function(error, departuresMonths) {
      d3.selectAll("input").on("change", function () {
        var arrivals = document.getElementById("arrivalDir").checked;
        process(csvData, arrivals ? arrivalsMonths : departuresMonths, arrivals);
      });

      var arrivals = document.getElementById("arrivalDir").checked;
      process(csvData, arrivals ? arrivalsMonths : departuresMonths, arrivals);
    })
  })
})

var dd, cc, ff;
dd = d3.select("#date");

function process(csvData, months, arrivals) {
  var countries = csvData
    .filter(function (c) {
      return typeof months[0][c.country] !== "undefined" && c.country.indexOf("Total") < 0 && c.country.indexOf("Other") < 0;
    }),
    aus = map.latLngToXY(ausLat[0], ausLat[1]);

  countries
    .forEach(function (c) {
      var coord = map.latLngToXY(c.latitude,c.longitude);
      c.x = coord[0];
      c.y = coord[1];
    });

  if (dd) dd.interrupt().transition();
  if (ff) ff.interrupt().transition();
  if (cc) cc.interrupt().transition();
  // d3.timer.flush();

  var g = d3.select("svg").append("g");
/*
  var pp = g.selectAll(".route")
    .data(countries, function(c,i) { if (c) {return c.country;}else{console.log(i); return c;} })
    .enter()
      .append("path")
        .attr("class", "route")
        .attr("stroke", "#1f1")
        .attr("stroke-width", 20)
        .attr("d", function(c) { return "M "+aus[0]+" "+aus[1]+" L "+c.x+" "+c.y; });
*/

  var bub = g.selectAll(".bub")
    .data(countries, function(c,i) { if (c) {return c.country;}else{console.log(i); return c;} });
  cc = bub
    .enter()
      .append("circle")
      .attr("class", "bub")
      .attr("cx", function (c) { return c.x; })
      .attr("cy", function (c) { return c.y; })
      .attr("opacity", 0.7)
      .attr("stroke", "white")
      .attr("stroke-width", 2)
      .attr("r", 0)
      .style("fill", "#f1f")
      .each(function () { d3.select(this).append("title").text(function(c) { return c.country; }) });
  bub.exit().remove();

  var fly = g.selectAll(".fly")
    .data(countries, function(c,i) { if (c) {return c.country;}else{console.log(i); return c;} });
  ff = fly
    .enter()
      .append("circle")
      .attr("class", "fly")
      .attr("cx", aus[0])
      .attr("cy", aus[1])
      .attr("opacity", 0.7)
      .attr("stroke", "black")
      .attr("stroke-width", 1)
      .attr("r", 5)
      .style("fill", "#1ff");
  fly.exit().remove();

  var flyTime = 1000, growTime = 1000, resetTime = 100, time = resetTime+flyTime+growTime, delta = 1;

  months
    .forEach(function (m, i) {
      // change month
      dd.transition()
        .delay(i*time)
        .text((arrivals ? "Inbound visitors in " : "Outbound Aussies in ") + m.month);

      // fly to destination
      ff.transition()
        .delay(resetTime+(i*time))
        .duration(flyTime)
        .attr("cx", function(d) { return arrivals ? aus[0] : d.x; })
        .attr("cy", function(d) { return arrivals ? aus[1] : d.y; })
        .attr("r", 3)
        .each("start", function () {
          // reset to Australia
          d3.select(this)
            .attr("r", 5)
            .attr("cx", function(d) { return arrivals ? d.x : aus[0]; })
            .attr("cy", function(d) { return arrivals ? d.y : aus[1]; });
        })
        .each("end", function () {
          // shrink at end
          d3.select(this)
            .attr("r", 2);
        });

      // fade destination
      cc.transition()
        .delay((i*time))
        .duration(flyTime)
        .attr("opacity", 0.1);

      // resize destination
      cc.transition()
        .delay(flyTime+(i*time))
        .duration(growTime)
        .attr("opacity", 0.7)
        .attr("r", function(d) { return bsize(m[d.country]); });

    })
}

function bsize(n) {
  return typeof n === "undefined" ? 0 : (n < 100000 ? Math.log(1+n)/Math.log(1.6) : 50);
}

// map.bubbles(bombs, {});

</script>

