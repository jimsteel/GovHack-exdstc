<html>
<title>Hither and Thither</title>
<script src="d3/d3.v3.min.js"></script>
<script src="d3/topojson.v1.min.js"></script>
<script src="js/datamaps.world.min.js"></script>
<h1>Hither and Thither</h1>
<span id="date">None</span>
<div id="container" style="position: relative; width: 95%; height: 95%;">
</div>
<script>
var width=document.getElementById("container").offsetWidth,
    height=document.getElementById("container").offsetHeight,
    projection = d3.geo
                   .mercator()
                   .scale(150)
                   .translate([width / 2, height / 2]);
var path = d3.geo
             .path()
             .pointRadius(2)
             .projection(projection);

var map = new Datamap({
  element: document.getElementById('container'),
  projection: 'mercator',
  fills: { "bubble": "#1ff", "x": "#f1f" },
  bubbleConfig: {
            borderWidth: 2,
            borderColor: '#FFFFFF',
            popupOnHover: false,
            popupTemplate: function(geography, data) {
              return '<div class="hoverinfo"><strong>' + data.name + '</strong></div>';
            },
            fillOpacity: 0.75,
            highlightOnHover: true,
            highlightFillColor: '#FC8D59',
            highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
            highlightBorderWidth: 2,
            highlightFillOpacity: 0.85
        }
});

var time = 100;

d3.csv('data/countries.csv', function(error, csvData) {

  var countries = csvData
    .filter(function (c) {
      return c.country.indexOf("Total") < 0 && c.country.indexOf("Other") < 0;
    }),
    aus = map.latLngToXY(-25.27439, 133.775136);

  countries
    .forEach(function (c) {
      var coord = map.latLngToXY(c.latitude,c.longitude);
      c.x = coord[0];
      c.y = coord[1];
    });
  // map.bubbles(countries);

console.log(path({type: "LineString", coordinates: [[-25.27439, 133.775136], [-25,100]]}));

  var g = d3.select("svg").append("g");
  var dd = d3.select("#date");
  var pp = g.selectAll(".route")
    .data(countries, function(c,i) { if (c) {return c.country;}else{console.log(i); return c;} })
    .enter()
      .append("path")
/*
        .datum(function (c) { // var p = ""; console.log(p);
          return {type: "LineString", coordinates: [[-25.27439, 133.775136], [c.latitude,c.longitude]]}; })
*/
        .attr("class", "route")
        .attr("fill", "none")
        .attr("stroke", "#ff1")
        .attr("stroke-width", 20)
        .attr("d", function(c) { return "M "+aus[0]+" "+aus[1]+" L "+c.x+" "+c.y; });

  var cc = g.selectAll(".bub")
    .data(countries, function(c,i) { if (c) {return c.country;}else{console.log(i); return c;} })
    .enter()
      .append("circle")
      .attr("class", "bub")
      .attr("cx", function (c) { return c.x; })
      .attr("cy", function (c) { return c.y; })
      .attr("opacity", 0.7)
      .attr("stroke", "white")
      .attr("stroke-width", 2)
      .attr("r", 0)
      .style("fill", "#f1f")
      .each(function () { d3.select(this).append("title").text(function(c) { return c.country; }) });

  d3.csv('data/340109.csv', function(error, months) {
    months.forEach(function (m, i) {
      dd.transition()
        .delay(1.5 * i * time)
        .text(m.month);
      cc.transition()
        .delay(1.5 * i * time)
        .duration(time)
        .attr("r", function(d) { return bsize(m[d.country]); });
    })
  })

})

function bsize(n) {
  return n < 100000 ? Math.log(1+n)/Math.log(1.6) : 50;
}

// map.bubbles(bombs, {});

</script>

