<html>
<script src="d3/d3.v3.min.js"></script>
<script src="d3/topojson.v1.min.js"></script>
<script src="js/datamaps.world.min.js"></script>
<div id="container" style="position: relative; width: 95%; height: 95%;">
<h1>Hither and Thither</h1>
</div>
<script>
var map = new Datamap({
  element: document.getElementById('container'),
  fills: { "bubble": "#1ff", "x": "#f1f" },
  bubbleConfig: {
            borderWidth: 2,
            borderColor: '#FFFFFF',
            popupOnHover: false,
            popupTemplate: function(geography, data) {
              return '<div class="hoverinfo"><strong>' + data.name + '</strong></div>';
            },
            fillOpacity: 0.75,
            highlightOnHover: true,
            highlightFillColor: '#FC8D59',
            highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
            highlightBorderWidth: 2,
            highlightFillOpacity: 0.85
        }
});

var time = 100;

d3.csv('data/countries.csv', function(error, csvData) {

  var countries = csvData
    .filter(function (c) {
      return c.country.indexOf("Total") < 0 && c.country.indexOf("Other") < 0;
    })
  countries
    .forEach(function (c) {
      var coord = map.latLngToXY(c.latitude,c.longitude);
      c.x = coord[0];
      c.y = coord[1];
    });
  // map.bubbles(countries);

  var g = d3.select("svg").append("g");
  var cc = g.selectAll(".bub")
    .data(countries, function(c,i) { if (c) {return c.country;}else{console.log(i); return c;} })
    .enter()
      .append("circle")
      .attr("class", "bub")
      .attr("cx", function (c) { return c.x; })
      .attr("cy", function (c) { return c.y; })
      .attr("opacity", 0.7)
      .attr("stroke", "white")
      .attr("stroke-width", 2)
      .attr("r", 0)
      .style("fill", "#f1f")
      .each(function () { d3.select(this).append("title").text(function(c) { return c.country; }) });

  d3.csv('data/340109.csv', function(error, months) {
    months.forEach(function (m, i) {
      cc.transition()
        .delay(1.5 * i * time)
        .duration(time)
        .attr("r", function(d) { return bsize(m[d.country]); });
    })
  })

})

function bsize(n) {
  return n < 100000 ? Math.log(1+n)/Math.log(1.6) : 50;
}

// map.bubbles(bombs, {});

</script>

